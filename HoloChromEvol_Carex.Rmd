---
title: "HoloChromEvol_Carex"
author: "Marcial"
date: "08/02/2017"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


Setting up the tree

```{r}

library(ape)

#opening tree
phy <- read.tree("Carex_megaphylogeny.dated.out")
phy
length(phy$tip.label)
is.ultrametric(phy)
plot(phy, show.tip.label=F)

#it is not ultrametric, see this post
#http://blog.phytools.org/2016/08/fixing-ultrametric-tree-whose-edges-are.html
library(phytools)
library(phangorn)
## compute the NNLS ultrametric tree
phy<-nnls.tree(cophenetic(phy),phy,rooted=TRUE)
## check
is.ultrametric(phy)

#Now we are making the tree dichotomous
phy <- multi2di(phy)
is.ultrametric(phy)
is.rooted(phy)


#Loading the data
mydata <- read.csv("tiplabels.txt", sep= ";")
mydata


#Pruning the tree

drop<-read.csv("droptips.csv", header=F,sep=";")
drop<-as.char.pacter(drop[,1]) #Convierto en caracter, porque es obligatorio para hacer el pruning

phy<-drop.tip(phy=phy, tip=drop, subtree=F)

setdiff(phy$tip.label, mydata[,1]) 

#The tree is ready for the analyses!!!!!!

#OK but this is an easier way because you don't have to create a list
#Look
tips.to.remove <- setdiff(phy$tip.label, mydata[,1])
phy <- drop.tip(phy, tips.to.remove)
setdiff(phy$tip.label, mydata[,1]) 
#This way you don't need to create an file like droptips.csv


#Setting the char.pacter
char.p <- mydata[,3] 
names(char.p) = mydata[,1]
char.p

#Setting the char.pacter variation
sd <- mydata[,6]
names(sd) = mydata[,1]
sd

```


OK. Now the Quasse analyses

```{r}
library(diversitree)

p <- starting.point.quasse(phy, char.p)
p

xr <- range(char.p) + c(-1, 1) * 20 * p["diffusion"]
xr

linear.x <- make.linear.x(xr[1], xr[2])
make <- function(lambda, mu) make.quasse(phy, char.p, sd, lambda, mu, sampling.f=0.30)
nodrift <- function(f) constrain(f, drift ~ 0)
f.c.c <- make(constant.x, constant.x)
f.l.c <- make(linear.x, constant.x)
f.s.c <- make(sigmoid.x, constant.x) 
f.h.c <- make(noroptimal.x, constant.x) 
 

control <- list(parscale = 0.1, reltol = 0.001)
chrom.mle.c.c <- find.mle(nodrift(f.c.c), p, lower = 0, control = control, verbose = 0)



p.c <- chrom.mle.c.c$par
p.c
p.l.c <- c(p.c[1], l.m = 0, p.c[2:3])
p.l.c
p.s.c <- c(p.c[1], p.c[1], mean(char.p), 1, p.c[2:3])
p.s.c
p.h.c <- c(p.c[1], p.c[1], mean(char.p), 1, p.c[2:3])
p.h.c

chrom.mle.d.c.c <- find.mle(f.c.c, coef(chrom.mle.c.c, TRUE), control = control, verbose = 0)
chrom.mle.l.c <- find.mle(nodrift(f.l.c), p.l.c, control = control, verbose = 0)
chrom.mle.d.l.c <- find.mle(f.l.c, coef(chrom.mle.l.c, TRUE), control = control, verbose = 0)
chrom.mle.s.c <- find.mle(nodrift(f.s.c), p.s.c, control = control, verbose = 0)
chrom.mle.d.s.c <- find.mle(f.s.c, coef(chrom.mle.s.c, TRUE), control = control, verbose = 0)
chrom.mle.h.c <- find.mle(nodrift(f.h.c), p.h.c, control = control, verbose = 0)
chrom.mle.d.h.c <- find.mle(f.h.c, coef(chrom.mle.h.c, TRUE), control = control, verbose = 0)


chrom.anova <- anova(chrom.mle.c.c, OU.constant.constant = chrom.mle.d.c.c, BM.linear.constant = chrom.mle.l.c, OU.linear.constant = chrom.mle.d.l.c, BM.sigmoid.constant = chrom.mle.s.c, OU.sigmoid.constant = chrom.mle.d.s.c, BM.hump.constant = chrom.mle.h.c, OU.hump.constant = chrom.mle.d.h.c)

chrom.anova

save.image(file="myEnvironment.RData")
```


Let's check the results

```{r}


#printing results
char.p.p <- seq(12,132)
lambda.d.h.c <- noroptimal.x(char.p, chrom.mle.d.h.c$par[1], chrom.mle.d.h.c$par[2], chrom.mle.d.h.c$par[3], chrom.mle.d.h.c$par[4])
plot(char.p, lambda.d.h.c, type = "l")
lambda.d.c.c <- constant.x(char.p, chrom.mle.d.c.c$par[1])
plot(char.p, lambda.d.c.c, type = "l")
lambda.d.s.c <- sigmoid.x(char.p, chrom.mle.d.s.c$par[1], chrom.mle.d.s.c$par[2], chrom.mle.d.s.c$par[3], chrom.mle.d.s.c$par[4])
plot(char.p, lambda.d.s.c, type = "l")
lambda.d.l.c <- linear.x(char.p, chrom.mle.d.l.c$par[1], chrom.mle.d.l.c$par[2])
plot(char.p, lambda.d.l.c, type = "l")

lambda.h.c <- noroptimal.x(char.p, chrom.mle.h.c$par[1], chrom.mle.h.c$par[2], chrom.mle.h.c$par[3], chrom.mle.h.c$par[4])
plot(char.p, lambda.h.c, type = "l")
lambda.c.c <- constant.x(char.p, chrom.mle.c.c$par[1])
plot(char.p, lambda.c.c, type = "l")
lambda.s.c <- sigmoid.x(char.p, chrom.mle.s.c$par[1], chrom.mle.s.c$par[2], chrom.mle.s.c$par[3], chrom.mle.s.c$par[4])
plot(char.p, lambda.s.c, type = "l")
lambda.l.c <- linear.x(char.p, chrom.mle.l.c$par[1], chrom.mle.l.c$par[2])
plot(char.p, lambda.l.c, type = "l")

# the plot of the current best model... it's little rare, the peak is too much strong

save.image(file="myEnvironment.RData")

```

Let's explore more models

```{r}

p.c.l <- c(p.c[1:2], m.m = 0, p.c[3]) 
p.c.l
p.c.s <- c(p.c[1:2], p.c[2], mean(char), 1, p.c[3])
p.c.s
p.c.h <- c(p.c[1:2], p.c[2], mean(char), 1, p.c[3])
p.c.h

chrom.mle.c.l <- find.mle(nodrift(f.c.l), p.c.l, control = control, verbose = 0)
chrom.mle.d.c.l <- find.mle(f.c.l, coef(chrom.mle.c.l, TRUE), control = control, verbose = 0)
chrom.mle.c.s <- find.mle(nodrift(f.c.s), p.c.s, control = control, verbose = 0)
chrom.mle.d.c.s <- find.mle(f.c.s, coef(chrom.mle.c.s, TRUE), control = control, verbose = 0)
chrom.mle.c.h <- find.mle(nodrift(f.c.h), p.c.h, control = control, verbose = 0)
chrom.mle.d.c.h <- find.mle(f.c.h, coef(chrom.mle.c.h, TRUE), control = control, verbose = 0)


chrom.anova2 <- anova(chrom.mle.c.c, OU.constant.constant = chrom.mle.d.c.c, BM.linear.constant = chrom.mle.l.c, BM.constant.linear = chrom.mle.c.l, OU.linear.constant = chrom.mle.d.l.c, OU.constant.linear = chrom.mle.d.c.l, BM.sigmoid.constant = chrom.mle.s.c, OU.sigmoid.constant = chrom.mle.d.s.c, BM.constant.sigmoid = chrom.mle.c.s, OU.constant.sigmoid = chrom.mle.d.c.s, BM.hump.constant = chrom.mle.h.c, OU.hump.constant = chrom.mle.d.h.c, BM.constant.hump = chrom.mle.c.h, OU.constant.hump = chrom.mle.d.c.h)


chrom.anova2


save.image(file="myEnvironment.RData")

```

